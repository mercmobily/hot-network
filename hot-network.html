<link rel="import" href="../polymer/polymer.html">

<!--
`hot-network`

@demo demo/index.html
-->

<!--
TODO:
* 1. Add option to tap on form to reload, redo overlay so that it makes anything unclickable
* 2. Check that snippet selector will work fine with hot-network, document hot-network
* 5. Make hotNetwork loadign CSS a little prettier
-->

<dom-module id="hot-network">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
      };

     /** Standard overlay CSS.
       * The only "strange" part is the z-index, which needs to be high
       * so that the overlay catches everything
     */
      #overlay {
        display: block;
        position: absolute;
        top:0;
        left:0;
        right:0;
        bottom:0;
        padding: 10px;
        color:white;
        z-index:9999;
        @apply(--hot-network-overlay);
      };


      #overlay.loading {
        opacity: 0.1;
        background-color: grey;
        @apply(--hot-network-overlay-loading);
      }

      #overlay.loaded {
        background-color: none;
        z-index:0;
        @apply(--hot-network-overlay-loaded);
      }

      #overlay.error {
        opacity: 0.1;
        background-color: red;
        @apply(--hot-network-overlay-error);
      }


      #content-wrapper {
        padding: 10px;
        @apply(--hot-network-content-wrapper);
      };

      #content-wrapper.loading {
        opacity: 0.3;
        @apply(--hot-network-content-wrapper-loading);
      }

      #content-wrapper.loaded {
        @apply(--hot-network-content-wrapper-loaded);
      }

      #content-wrapper.error {
        opacity: 0.3;
        @apply(--hot-network-content-wrapper-error);
      }

    </style>

    <div>
      <div id="overlay" on-tap="_overlayTapped" class$="{{status}}"></div>
      <div id="content-wrapper" class$="{{status}}">
        <content></content>
      </div>
    </div>

  </template>

  <script>
    Polymer({

      is: 'hot-network',

      properties: {

        emitter: Object,

        status: {
          type: String,
          notify: true,
          value: "loaded",
          observer: "_statusChanged",
        },

        emitterId: String,
        emitterProperty: String,
      },

      _overlayTapped: function( e ){
        debugger;
        e.stopPropagation();
        e.preventDefault();
        if( this.status == 'error' ){
          debugger;
          this.emitter.generateRequest();
        }
      },

      _statusChanged: function( s ){
        this.updateStyles();
      },

      _findFirstChildElement: function(){
         var firstElement = this.getEffectiveChildren()[0];
         if( firstElement ){
           if( this.emitterProperty ){
             return firstElement[ this.emitterProperty ]
           } else {
             return firstElement.request ? firstElement.request : firstElement;
          }
         }
      },

      _findEmitterNode: function( node ){
        var emitter;
        var emitterId = this.emitterId;
        var emitterProperty = this.emitterProperty;
        var quitVisit = false;
        function visitChildrenOf( node ){
          var effectiveChildNodes = Polymer.dom( node ).getEffectiveChildNodes();
          for( var i = 0, l = effectiveChildNodes.length; i < l; i ++ ){
            var node = effectiveChildNodes[ i ];

            // Quit if quitVisit is true.
            if( quitVisit ) return;

            // Only deals with ELEMENTS
            if( node.nodeType !== Node.ELEMENT_NODE ) continue;

            // Look for request objects within element (in .request)
            if( node.id === emitterId ){
              emitter = emitterProperty ? node[ emitterProperty ] : node;
              quitVisit = true;
              break;
            }
            visitChildrenOf( node );
          };
        }
        visitChildrenOf( this );

        return emitter;
      },

      attached: function(){

        this.async( function() {

          if( this.emitterId ){
            this.emitter = this._findEmitterNode();
          } else {
            this.emitter = this._findFirstChildElement();
          }

          if( this.emitter ){
            this.listen( this.emitter, "error", "_catcher" );
            this.listen( this.emitter, "response", "_catcher" );
            this.listen( this.emitter, "request", "_catcher" );
          }
        });
      },

      detached: function(){
        if( this.emitter ){
          this.unlisten( this.emitter, "error", "_catcher" );
          this.unlisten( this.emitter, "response", "_catcher" );
          this.unlisten( this.emitter, "request", "_catcher" );
        }
      },

      _catcher: function( e ){
        console.log("Status before: ", this.status );

        this.status = ( {
          error: 'error',
          request: 'loading',
          response: 'loaded',
        }[ e.type ] ) || "error";

        console.log("Status after: ", this.status );
      }



    });
  </script>
</dom-module>
